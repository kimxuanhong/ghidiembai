import{o as V,c as i,a as r,b as G,d as n,F as C,r as $,t as _,n as x,e as D,f as A,g as S,w as R,h as k,i as N,v as H,j as M,k as L,u as K,s as z,l as U,m as T,p as j,q,x as O,y as X,z as P,A as W}from"./index.js";const J={class:"confetti-container",id:"confettiContainer"},Q={__name:"ConfettiContainer",setup(f){const y=["#FFD700","#FF6347","#00FF7F","#1E90FF","#FF1493","#ADFF2F"];function c(){const e=document.getElementById("confettiContainer");if(!e)return;e.innerHTML="";const s=150;for(let o=0;o<s;o++){const t=document.createElement("div");t.className="confetti",t.style.backgroundColor=y[Math.floor(Math.random()*y.length)],t.style.left=Math.random()*100+"vw",t.style.transform=`rotate(${Math.random()*360}deg)`,t.style.width=Math.random()*8+6+"px",t.style.height=Math.random()*8+6+"px",t.style.opacity=Math.random()+.5;const v=Math.random()*3+2;t.style.animation=`fall ${v}s linear forwards`,t.style.animationDelay=Math.random()*5+"s",e.appendChild(t)}}return V(()=>{c()}),(e,s)=>(r(),i("div",J))}},Y={class:"score-table-container"},Z={id:"scoreTable"},ee=["id"],te={id:"scoreTableBody"},ne=["onClick"],ae={id:"totalScores"},se={__name:"ScoreTable",props:{game:{type:Object,required:!0},totalScores:{type:Array,default:()=>[0,0,0,0]},winnerIndex:{type:Number,default:-1}},emits:["edit-row"],setup(f,{emit:y}){const c=f,e=G(()=>{var t;return[...((t=c.game)==null?void 0:t.scores)||[]].reverse()}),s=y;function o(t){if(c.game.isEnded)return;const v=c.game.scores.length-1-t;s("edit-row",v)}return(t,v)=>(r(),i("div",Y,[n("table",Z,[n("thead",null,[n("tr",null,[v[0]||(v[0]=n("th",null,"Vòng",-1)),(r(!0),i(C,null,$(f.game.players,(h,m)=>(r(),i("th",{key:m,id:`player${m+1}Header`},_(h),9,ee))),128))])]),n("tbody",te,[(r(!0),i(C,null,$(e.value,(h,m)=>(r(),i("tr",{key:m,onClick:g=>o(m),style:x({cursor:f.game.isEnded?"default":"pointer"})},[n("td",null,_(e.value.length-m),1),(r(!0),i(C,null,$(h,(g,p)=>(r(),i("td",{key:p},_(g!==void 0?g:0),1))),128))],12,ne))),128))]),n("tfoot",null,[n("tr",ae,[v[1]||(v[1]=n("td",null,"Tổng",-1)),(r(!0),i(C,null,$(f.totalScores,(h,m)=>(r(),i("td",{key:m,class:D({winner:f.winnerIndex===m})},_(h),3))),128))])])])]))}},le={key:0,id:"scoreModal",class:"modal"},oe={class:"modal-content"},re={class:"player-inputs"},ie=["id","for"],ue=["id","onUpdate:modelValue","onFocus"],ce={class:"number-pad"},de=["onClick"],ve={class:"modal-buttons"},me=["disabled"],fe={__name:"ScoreModal",props:{show:{type:Boolean,default:!1},players:{type:Array,default:()=>[]},editingScores:{type:Array,default:null}},emits:["close","save"],setup(f,{emit:y}){const c=f,e=y,s=A([0,0,0,0]),o=S(null);R(()=>c.show,a=>{if(a&&(t(),c.editingScores))for(let d=0;d<c.editingScores.length&&d<4;d++)s[d]=c.editingScores[d]}),R(()=>c.editingScores,a=>{if(a&&a.length)for(let d=0;d<a.length&&d<4;d++)s[d]=a[d]},{immediate:!0}),V(()=>{document.addEventListener("keydown",p)});function t(){for(let a=0;a<4;a++)s[a]=0}function v(a){o.value=a}function h(a){if(o.value===null)return;const d=s[o.value],b=parseInt(`${d}${a}`);s[o.value]=b}function m(){o.value!==null&&(s[o.value]=-s[o.value])}function g(){if(o.value===null)return;const a=s[o.value].toString();a.length<=1?s[o.value]=0:s[o.value]=parseInt(a.slice(0,-1))}function p(a){c.show&&(a.key==="Enter"?E()&&F():a.key==="Escape"?I():/^\d$/.test(a.key)?o.value!==null&&h(a.key):a.key==="-"||a.key==="+"?o.value!==null&&m():a.key==="Backspace"&&o.value!==null&&g())}function E(){return s.some(a=>a!==null)}function F(){e("save",[...s])}function I(){e("close")}return(a,d)=>f.show?(r(),i("div",le,[n("div",oe,[n("div",re,[(r(!0),i(C,null,$(f.players,(b,l)=>(r(),i("div",{key:l,class:"input-group"},[n("label",{id:`label${l+1}`,for:`score${l+1}`},_(b)+":",9,ie),N(n("input",{type:"number",id:`score${l+1}`,"onUpdate:modelValue":u=>s[l]=u,onFocus:u=>v(l),class:D({"selected-input":o.value===l})},null,42,ue),[[H,s[l]]])]))),128))]),n("div",ce,[(r(),i(C,null,$(9,b=>n("button",{key:b,class:"num-btn",onClick:l=>h(b)},_(b),9,de)),64)),n("button",{class:"num-btn",onClick:d[0]||(d[0]=b=>h(0))},"0"),n("button",{class:"clear-btn",onClick:m},"+/-"),n("button",{class:"backspace-btn",onClick:g},"←")]),n("div",ve,[n("button",{id:"confirmScore",class:"confirm-btn",disabled:!E(),onClick:F}," Xác nhận ",8,me),n("button",{id:"cancelScore",class:"secondary-btn",onClick:I},"Hủy")])])])):k("",!0)}},he={key:0,id:"endGameModal",class:"modal"},ye={__name:"EndGameModal",props:{show:{type:Boolean,default:!1}},emits:["close","confirm"],setup(f,{emit:y}){const c=y;function e(){c("confirm")}function s(){c("close")}return(o,t)=>f.show?(r(),i("div",he,[n("div",{class:"modal-content"},[t[0]||(t[0]=n("h2",null,"Xác nhận kết thúc",-1)),t[1]||(t[1]=n("p",{class:"modal-message"}," Bạn có chắc chắn muốn kết thúc ván bài này? Sau khi kết thúc sẽ không thể chỉnh sửa điểm. ",-1)),n("div",{class:"modal-buttons"},[n("button",{id:"confirmEndGame",class:"danger-btn",onClick:e},"Kết thúc"),n("button",{id:"cancelEndGame",class:"secondary-btn",onClick:s},"Hủy")])])])):k("",!0)}},ke={key:0,class:"container",id:"content"},pe={key:1,class:"winner-message"},be={class:"header"},ge={key:0,class:"room-badge"},_e={key:0,class:"table-header"},we={__name:"ScoringView",setup(f){const y=K(),c=S(M()),e=S(null),s=S(!1),o=S(!1),t=S(null),v=S(""),h=S(""),m=G(()=>{if(!e.value||!e.value.scores)return[0,0,0,0];const l=[0,0,0,0];return e.value.scores.forEach(u=>{u&&u.forEach((w,B)=>{typeof w=="number"&&(l[B]+=w)})}),l}),g=G(()=>m.value.reduce((l,u,w,B)=>u>B[l]?w:l,0)),p=G(()=>e.value&&e.value.isEnded);V(()=>{const l=L();if(!l){alert("Không tìm thấy thông tin ván bài!"),y.push("/");return}z(M(),l.firebaseId,l,u=>{e.value=u,e.value.scores||(e.value.scores=[]),e.value.totalScores||(e.value.totalScores=[0,0,0,0]),O(e.value),e.value.isEnded&&a()})}),U(()=>{q()});function E(){y.push("/")}function F(){t.value=null,s.value=!0}function I(l){p.value||(t.value=l,s.value=!0)}function a(){if(!e.value||!e.value.players)return;v.value="Game đã kết thúc";const l=e.value.players[g.value];h.value=`${l} chiến thắng! 🎉`}async function d(l){try{t.value!==null?await X(M(),e.value.firebaseId,t.value,l):await P(M(),e.value.firebaseId,l),s.value=!1,t.value=null}catch(u){console.error("Lỗi khi lưu điểm:",u),alert("Có lỗi xảy ra khi lưu điểm. Hệ thống sẽ thử lưu cục bộ."),s.value=!1,t.value=null}}async function b(){try{e.value.isEnded=!0,e.value.endDate=new Date().toISOString(),await W(M(),e.value.firebaseId),a(),o.value=!1}catch(l){console.error("Lỗi khi kết thúc game:",l),alert("Có lỗi xảy ra khi kết thúc ván đấu. Vui lòng thử lại.")}}return(l,u)=>e.value?(r(),i("div",ke,[p.value?(r(),T(Q,{key:0})):k("",!0),h.value?(r(),i("div",pe,_(h.value),1)):k("",!0),n("div",be,[u[3]||(u[3]=n("h1",null,"Ghi Điểm Ván Bài",-1)),n("button",{class:"back-btn",onClick:E},"← Trở về"),c.value?(r(),i("div",ge," Phòng: "+_(c.value),1)):k("",!0)]),v.value?(r(),i("div",{key:2,id:"gameStatus",style:x({display:v.value?"block":"none"})},_(v.value),5)):k("",!0),n("div",{class:D(["score-section",{"game-ended":p.value}])},[p.value?k("",!0):(r(),i("div",_e,[n("button",{id:"endGameBtn",class:"danger-btn small-btn",onClick:u[0]||(u[0]=w=>o.value=!0)}," Kết thúc ván ")])),j(se,{game:e.value,totalScores:m.value,winnerIndex:p.value?g.value:-1,onEditRow:I},null,8,["game","totalScores","winnerIndex"])],2),p.value?k("",!0):(r(),i("button",{key:3,id:"addScoreBtn",class:"primary-btn",onClick:F}," Thêm điểm mới ")),s.value?(r(),T(fe,{key:4,show:s.value,players:e.value.players,editingScores:t.value!==null?e.value.scores[t.value]:null,onClose:u[1]||(u[1]=w=>s.value=!1),onSave:d},null,8,["show","players","editingScores"])):k("",!0),o.value?(r(),T(ye,{key:5,show:o.value,onClose:u[2]||(u[2]=w=>o.value=!1),onConfirm:b},null,8,["show"])):k("",!0)])):k("",!0)}};export{we as default};
