import{d as V,u as M,o as R,c as u,a as l,b as N,e as n,F as _,r as C,t as S,n as x,f as I,_ as T,g as A,h as F,w as $,i as v,j as H,k as D,l as L,m as U,p as K,q as i,s as E,v as W}from"./index.js";const j=V("game",{state:()=>({currentRoom:"",game:null,editingRowIndex:null,gameStatus:"",winnerMessage:""}),getters:{totalScores:t=>{if(!t.game||!t.game.scores)return[0,0,0,0];const a=[0,0,0,0];return t.game.scores.forEach(e=>{e&&e.forEach((s,o)=>{typeof s=="number"&&(a[o]+=s)})}),a},winnerIndex:t=>t.totalScores.length?t.totalScores.reduce((a,e,s,o)=>e>o[a]?s:a,0):0,isGameEnded:t=>t.game&&t.game.isEnded},actions:{initGame(){const t=M();this.currentRoom=t.getCurrentRoom();const a=t.getCurrentGame();return a?(t.subscribeToGamesScore(this.currentRoom,a.firebaseId,a,this.handleGameUpdate),!0):!1},handleGameUpdate(t){const a=M();this.game=t,this.game.scores||(this.game.scores=[]),this.game.totalScores||(this.game.totalScores=[0,0,0,0]),a.saveCurrentGame(this.game),this.game.isEnded&&this.displayWinner()},cleanupSubscriptions(){M().unsubscribeToGamesScore()},setEditingRowIndex(t){this.isGameEnded||(this.editingRowIndex=t)},displayWinner(){if(!this.game||!this.game.players)return;this.gameStatus="Game đã kết thúc";const t=this.game.players[this.winnerIndex];this.winnerMessage=`${t} chiến thắng! 🎉`},async saveScores(t){const a=M();try{return this.editingRowIndex!==null?await a.editScore(this.currentRoom,this.game.firebaseId,this.editingRowIndex,t):await a.addScore(this.currentRoom,this.game.firebaseId,t),this.editingRowIndex=null,!0}catch(e){return console.error("Lỗi khi lưu điểm:",e),this.editingRowIndex=null,!1}},async endGame(){const t=M();try{return this.game.isEnded=!0,this.game.endDate=new Date().toISOString(),await t.closeScore(this.currentRoom,this.game.firebaseId),this.displayWinner(),!0}catch(a){return console.error("Lỗi khi kết thúc game:",a),!1}}}}),q={class:"confetti-container",id:"confettiContainer"},z={__name:"ConfettiContainer",setup(t){const a=["#FFD700","#FF6347","#00FF7F","#1E90FF","#FF1493","#ADFF2F"];function e(){const s=document.getElementById("confettiContainer");if(!s)return;s.innerHTML="";const o=150;for(let r=0;r<o;r++){const c=document.createElement("div");c.className="confetti",c.style.backgroundColor=a[Math.floor(Math.random()*a.length)],c.style.left=Math.random()*100+"vw",c.style.transform=`rotate(${Math.random()*360}deg)`,c.style.width=Math.random()*8+6+"px",c.style.height=Math.random()*8+6+"px",c.style.opacity=Math.random()+.5;const b=Math.random()*3+2;c.style.animation=`fall ${b}s linear forwards`,c.style.animationDelay=Math.random()*5+"s",s.appendChild(c)}}return R(()=>{e()}),(s,o)=>(l(),u("div",q))}},O={class:"score-table-container"},X={id:"scoreTable"},P=["id"],J={id:"scoreTableBody"},Q=["onClick"],Y={id:"totalScores"},Z={__name:"ScoreTable",props:{game:{type:Object,required:!0},totalScores:{type:Array,default:()=>[0,0,0,0]},winnerIndex:{type:Number,default:-1}},emits:["edit-row"],setup(t,{emit:a}){const e=t,s=N(()=>{var c;return[...((c=e.game)==null?void 0:c.scores)||[]].reverse()}),o=a;function r(c){if(e.game.isEnded)return;const b=e.game.scores.length-1-c;o("edit-row",b)}return(c,b)=>(l(),u("div",O,[n("table",X,[n("thead",null,[n("tr",null,[b[0]||(b[0]=n("th",null,"Vòng",-1)),(l(!0),u(_,null,C(t.game.players,(p,f)=>(l(),u("th",{key:f,id:`player${f+1}Header`},S(p),9,P))),128))])]),n("tbody",J,[(l(!0),u(_,null,C(s.value,(p,f)=>(l(),u("tr",{key:f,onClick:g=>r(f),style:x({cursor:t.game.isEnded?"default":"pointer"})},[n("td",null,S(s.value.length-f),1),(l(!0),u(_,null,C(p,(g,h)=>(l(),u("td",{key:h},S(g!==void 0?g:0),1))),128))],12,Q))),128))]),n("tfoot",null,[n("tr",Y,[b[1]||(b[1]=n("td",null,"Tổng",-1)),(l(!0),u(_,null,C(t.totalScores,(p,f)=>(l(),u("td",{key:f,class:I({winner:t.winnerIndex===f})},S(p),3))),128))])])])]))}},ee={key:0,id:"scoreModal",class:"modal"},te={class:"modal-content"},ne={class:"player-cards"},se=["onClick"],oe={class:"player-name"},ae={key:0,class:"current-selection"},re={key:1,class:"current-selection"},ie={class:"number-pad"},le=["onClick","disabled"],ce=["disabled"],de=["disabled"],ue=["disabled"],me={class:"modal-buttons"},he=["disabled"],ge={__name:"ScoreModal",props:{show:{type:Boolean,default:!1},players:{type:Array,default:()=>[]},editingScores:{type:Array,default:null}},emits:["close","save"],setup(t,{emit:a}){const e=t,s=a,o=A([0,0,0,0]),r=F(null);$(()=>e.show,m=>{if(m&&(c(),e.editingScores))for(let d=0;d<e.editingScores.length&&d<4;d++)o[d]=e.editingScores[d]}),$(()=>e.editingScores,m=>{if(m&&m.length)for(let d=0;d<m.length&&d<4;d++)o[d]=m[d]},{immediate:!0});function c(){for(let m=0;m<4;m++)o[m]=0}function b(m){r.value=m}function p(m){if(r.value===null)return;const d=o[r.value],k=d<0,y=Math.abs(d),w=parseInt(`${y}${m}`);o[r.value]=k?-w:w}function f(){r.value!==null&&(o[r.value]=-o[r.value])}function g(){if(r.value===null)return;const m=o[r.value],d=m<0,y=Math.abs(m).toString();if(y.length<=1)o[r.value]=0;else{const w=parseInt(y.slice(0,-1));o[r.value]=d?-w:w}}function h(){return o.some(m=>m!==0)}function G(){s("save",[...o])}function B(){s("close")}return(m,d)=>t.show?(l(),u("div",ee,[n("div",te,[d[3]||(d[3]=n("h3",null,"Nhập điểm",-1)),n("div",ne,[(l(!0),u(_,null,C(t.players,(k,y)=>(l(),u("div",{key:y,class:I(["player-card",{"selected-player":r.value===y}]),onClick:w=>b(y)},[n("div",oe,S(k),1),n("div",{class:I(["player-score",{negative:o[y]<0}])},S(o[y]),3)],10,se))),128))]),r.value!==null?(l(),u("div",ae,[n("p",null,[d[1]||(d[1]=H("Đang nhập điểm cho: ")),n("strong",null,S(t.players[r.value]),1)])])):(l(),u("div",re,d[2]||(d[2]=[n("p",null,"Hãy chọn người chơi",-1)]))),n("div",ie,[(l(),u(_,null,C(9,k=>n("button",{key:k,class:"num-btn",onClick:y=>p(k),disabled:r.value===null},S(k),9,le)),64)),n("button",{class:"num-btn",onClick:d[0]||(d[0]=k=>p(0)),disabled:r.value===null},"0",8,ce),n("button",{class:"clear-btn",onClick:f,disabled:r.value===null},"+/-",8,de),n("button",{class:"backspace-btn",onClick:g,disabled:r.value===null},"←",8,ue)]),n("div",me,[n("button",{id:"confirmScore",class:"confirm-btn",disabled:!h(),onClick:G}," Xác nhận ",8,he),n("button",{id:"cancelScore",class:"cancel-btn",onClick:B},"Hủy")])])])):v("",!0)}},fe=T(ge,[["__scopeId","data-v-62c91de8"]]),be={key:0,id:"endGameModal",class:"modal"},ye={__name:"EndGameModal",props:{show:{type:Boolean,default:!1}},emits:["close","confirm"],setup(t,{emit:a}){const e=a;function s(){e("confirm")}function o(){e("close")}return(r,c)=>t.show?(l(),u("div",be,[n("div",{class:"modal-content"},[c[0]||(c[0]=n("h2",null,"Xác nhận kết thúc",-1)),c[1]||(c[1]=n("p",{class:"modal-message"}," Bạn có chắc chắn muốn kết thúc ván bài này? Sau khi kết thúc sẽ không thể chỉnh sửa điểm. ",-1)),n("div",{class:"modal-buttons"},[n("button",{id:"confirmEndGame",class:"danger-btn",onClick:s},"Kết thúc"),n("button",{id:"cancelEndGame",class:"secondary-btn",onClick:o},"Hủy")])])])):v("",!0)}},ve={key:0,class:"container",id:"content"},Se={key:1,class:"winner-message"},pe={class:"header"},ke={key:0,class:"room-badge"},we={key:0,class:"table-header"},Ce={__name:"ScoringView",setup(t){const a=L(),e=j(),s=D(),o=F(!1);R(()=>{if(!e.initGame()){alert("Không tìm thấy thông tin ván bài!"),a.push("/");return}U(()=>{e.isGameEnded&&e.winnerMessage&&(o.value=!0)})}),K(()=>{e.cleanupSubscriptions(),o.value=!1});function r(){a.push("/")}function c(){e.setEditingRowIndex(null),s.showScoreModal()}function b(g){e.isGameEnded||(e.setEditingRowIndex(g),s.showScoreModal())}async function p(g){try{await e.saveScores(g)||alert("Có lỗi xảy ra khi lưu điểm. Hệ thống sẽ thử lưu cục bộ."),s.hideScoreModal()}catch(h){console.error("Lỗi khi lưu điểm:",h),alert("Có lỗi xảy ra khi lưu điểm. Hệ thống sẽ thử lưu cục bộ."),s.hideScoreModal()}}async function f(){try{await e.endGame()||alert("Có lỗi xảy ra khi kết thúc ván đấu. Vui lòng thử lại."),s.hideEndGameModal()}catch(g){console.error("Lỗi khi kết thúc game:",g),alert("Có lỗi xảy ra khi kết thúc ván đấu. Vui lòng thử lại.")}}return(g,h)=>i(e).game?(l(),u("div",ve,[o.value?(l(),E(z,{key:0})):v("",!0),i(e).winnerMessage?(l(),u("div",Se,S(i(e).winnerMessage),1)):v("",!0),n("div",pe,[h[3]||(h[3]=n("h1",null,"Ghi Điểm Ván Bài",-1)),n("a",{onClick:r,class:"back-btn",id:"backButton"},"← Trở về"),i(e).currentRoom?(l(),u("div",ke," Phòng: "+S(i(e).currentRoom),1)):v("",!0)]),i(e).gameStatus?(l(),u("div",{key:2,id:"gameStatus",style:x({display:i(e).gameStatus?"block":"none"})},S(i(e).gameStatus),5)):v("",!0),n("div",{class:I(["score-section",{"game-ended":i(e).isGameEnded}])},[i(e).isGameEnded?v("",!0):(l(),u("div",we,[n("button",{id:"endGameBtn",class:"danger-btn small-btn",onClick:h[0]||(h[0]=G=>i(s).showEndGameModal())}," Kết thúc ván ")])),W(Z,{game:i(e).game,totalScores:i(e).totalScores,winnerIndex:i(e).isGameEnded?i(e).winnerIndex:-1,onEditRow:b},null,8,["game","totalScores","winnerIndex"])],2),i(e).isGameEnded?v("",!0):(l(),u("button",{key:3,id:"addScoreBtn",class:"primary-btn",onClick:c}," Thêm điểm mới ")),i(s).scoreModalVisible?(l(),E(fe,{key:4,show:i(s).scoreModalVisible,players:i(e).game.players,editingScores:i(e).editingRowIndex!==null?i(e).game.scores[i(e).editingRowIndex]:null,onClose:h[1]||(h[1]=G=>i(s).hideScoreModal()),onSave:p},null,8,["show","players","editingScores"])):v("",!0),i(s).endGameModalVisible?(l(),E(ye,{key:5,show:i(s).endGameModalVisible,onClose:h[2]||(h[2]=G=>i(s).hideEndGameModal()),onConfirm:f},null,8,["show"])):v("",!0)])):v("",!0)}};export{Ce as default};
