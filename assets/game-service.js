import{d as V,u as G,o as F,c as u,a as l,b as D,e as n,F as C,r as M,t as v,n as x,f as E,_ as N,g as T,h as B,w as R,i as S,j as A,k as H,l as L,m as U,p as r,q as $,s as K}from"./index.js";const W=V("game",{state:()=>({currentRoom:"",game:null,editingRowIndex:null,gameStatus:"",winnerMessage:""}),getters:{totalScores:t=>{if(!t.game||!t.game.scores)return[0,0,0,0];const o=[0,0,0,0];return t.game.scores.forEach(e=>{e&&e.forEach((s,a)=>{typeof s=="number"&&(o[a]+=s)})}),o},winnerIndex:t=>t.totalScores.length?t.totalScores.reduce((o,e,s,a)=>e>a[o]?s:o,0):0,isGameEnded:t=>t.game&&t.game.isEnded},actions:{resetGameState(){this.gameStatus="",this.winnerMessage="",this.editingRowIndex=null},initGame(){const t=G();this.resetGameState(),this.currentRoom=t.getCurrentRoom();const o=t.getCurrentGame();return o?(t.subscribeToGamesScore(this.currentRoom,o.firebaseId,o,this.handleGameUpdate),!0):!1},handleGameUpdate(t){var s;const o=G(),e=(s=this.game)==null?void 0:s.firebaseId;this.game=t,e&&e!==t.firebaseId&&this.resetGameState(),this.game.scores||(this.game.scores=[]),this.game.totalScores||(this.game.totalScores=[0,0,0,0]),o.saveCurrentGame(this.game),this.game.isEnded?this.displayWinner():(this.winnerMessage="",this.gameStatus="")},cleanupSubscriptions(){G().unsubscribeToGamesScore(),this.resetGameState()},setEditingRowIndex(t){this.isGameEnded||(this.editingRowIndex=t)},displayWinner(){if(!this.game||!this.game.players)return;this.gameStatus="Game đã kết thúc";const t=this.game.players[this.winnerIndex];this.winnerMessage=`${t} chiến thắng! 🎉`},async saveScores(t){const o=G();try{return this.editingRowIndex!==null?await o.editScore(this.currentRoom,this.game.firebaseId,this.editingRowIndex,t):await o.addScore(this.currentRoom,this.game.firebaseId,t),this.editingRowIndex=null,!0}catch(e){return console.error("Lỗi khi lưu điểm:",e),this.editingRowIndex=null,!1}},async endGame(){const t=G();try{return this.game.isEnded=!0,this.game.endDate=new Date().toISOString(),await t.closeScore(this.currentRoom,this.game.firebaseId),this.displayWinner(),!0}catch(o){return console.error("Lỗi khi kết thúc game:",o),!1}}}}),j={class:"confetti-container",id:"confettiContainer"},q={__name:"ConfettiContainer",setup(t){const o=["#FFD700","#FF6347","#00FF7F","#1E90FF","#FF1493","#ADFF2F"];function e(){const s=document.getElementById("confettiContainer");if(!s)return;s.innerHTML="";const a=150;for(let i=0;i<a;i++){const c=document.createElement("div");c.className="confetti",c.style.backgroundColor=o[Math.floor(Math.random()*o.length)],c.style.left=Math.random()*100+"vw",c.style.transform=`rotate(${Math.random()*360}deg)`,c.style.width=Math.random()*8+6+"px",c.style.height=Math.random()*8+6+"px",c.style.opacity=Math.random()+.5;const y=Math.random()*3+2;c.style.animation=`fall ${y}s linear forwards`,c.style.animationDelay=Math.random()*5+"s",s.appendChild(c)}}return F(()=>{e()}),(s,a)=>(l(),u("div",j))}},z={class:"score-table-container"},O={id:"scoreTable"},X=["id"],P={id:"scoreTableBody"},J=["onClick"],Q={id:"totalScores"},Y={__name:"ScoreTable",props:{game:{type:Object,required:!0},totalScores:{type:Array,default:()=>[0,0,0,0]},winnerIndex:{type:Number,default:-1}},emits:["edit-row"],setup(t,{emit:o}){const e=t,s=D(()=>{var c;return[...((c=e.game)==null?void 0:c.scores)||[]].reverse()}),a=o;function i(c){if(e.game.isEnded)return;const y=e.game.scores.length-1-c;a("edit-row",y)}return(c,y)=>(l(),u("div",z,[n("table",O,[n("thead",null,[n("tr",null,[y[0]||(y[0]=n("th",null,"Vòng",-1)),(l(!0),u(C,null,M(t.game.players,(p,g)=>(l(),u("th",{key:g,id:`player${g+1}Header`},v(p),9,X))),128))])]),n("tbody",P,[(l(!0),u(C,null,M(s.value,(p,g)=>(l(),u("tr",{key:g,onClick:w=>i(g),style:x({cursor:t.game.isEnded?"default":"pointer"})},[n("td",null,v(s.value.length-g),1),(l(!0),u(C,null,M(p,(w,h)=>(l(),u("td",{key:h},v(w!==void 0?w:0),1))),128))],12,J))),128))]),n("tfoot",null,[n("tr",Q,[y[1]||(y[1]=n("td",null,"Tổng",-1)),(l(!0),u(C,null,M(t.totalScores,(p,g)=>(l(),u("td",{key:g,class:E({winner:t.winnerIndex===g})},v(p),3))),128))])])])]))}},Z={key:0,id:"scoreModal",class:"modal"},ee={class:"modal-content"},te={class:"player-cards"},ne=["onClick"],se={class:"player-name"},ae={key:0,class:"current-selection fly-in",style:{animationDelay:"0.4s"}},oe={key:1,class:"current-selection fly-in",style:{animationDelay:"0.4s"}},ie={class:"number-pad"},re=["onClick","disabled"],le=["disabled"],ce=["disabled"],de=["disabled"],ue={class:"modal-buttons"},me=["disabled"],he={__name:"ScoreModal",props:{show:{type:Boolean,default:!1},players:{type:Array,default:()=>[]},editingScores:{type:Array,default:null}},emits:["close","save"],setup(t,{emit:o}){const e=t,s=o,a=T([0,0,0,0]),i=B(null);R(()=>e.show,m=>{if(m&&(c(),e.editingScores))for(let d=0;d<e.editingScores.length&&d<4;d++)a[d]=e.editingScores[d]}),R(()=>e.editingScores,m=>{if(m&&m.length)for(let d=0;d<m.length&&d<4;d++)a[d]=m[d]},{immediate:!0});function c(){for(let m=0;m<4;m++)a[m]=0}function y(m){i.value=m}function p(m){if(i.value===null)return;const d=a[i.value],k=d<0,b=Math.abs(d),_=parseInt(`${b}${m}`);a[i.value]=k?-_:_}function g(){i.value!==null&&(a[i.value]=-a[i.value])}function w(){if(i.value===null)return;const m=a[i.value],d=m<0,b=Math.abs(m).toString();if(b.length<=1)a[i.value]=0;else{const _=parseInt(b.slice(0,-1));a[i.value]=d?-_:_}}function h(){return a.some(m=>m!==0)}function f(){s("save",[...a])}function I(){s("close")}return(m,d)=>t.show?(l(),u("div",Z,[n("div",ee,[d[3]||(d[3]=n("h3",null,"Nhập điểm",-1)),n("div",te,[(l(!0),u(C,null,M(t.players,(k,b)=>(l(),u("div",{key:b,class:E(["player-card fly-in",{"selected-player":i.value===b}]),style:x({animationDelay:b*.1+"s"}),onClick:_=>y(b)},[n("div",se,v(k),1),n("div",{class:E(["player-score",{negative:a[b]<0}])},v(a[b]),3)],14,ne))),128))]),i.value!==null?(l(),u("div",ae,[n("p",null,[d[1]||(d[1]=A("Đang nhập điểm cho: ")),n("strong",null,v(t.players[i.value]),1)])])):(l(),u("div",oe,d[2]||(d[2]=[n("p",null,"Hãy chọn người chơi",-1)]))),n("div",ie,[(l(),u(C,null,M(9,k=>n("button",{key:k,class:"num-btn",onClick:b=>p(k),disabled:i.value===null},v(k),9,re)),64)),n("button",{class:"num-btn",onClick:d[0]||(d[0]=k=>p(0)),disabled:i.value===null},"0",8,le),n("button",{class:"clear-btn",onClick:g,disabled:i.value===null},"+/-",8,ce),n("button",{class:"backspace-btn",onClick:w,disabled:i.value===null},"←",8,de)]),n("div",ue,[n("button",{id:"confirmScore",class:"confirm-btn fly-in",style:{animationDelay:"0.6s"},disabled:!h(),onClick:f}," Xác nhận ",8,me),n("button",{id:"cancelScore",class:"cancel-btn fly-in",style:{animationDelay:"0.65s"},onClick:I},"Hủy")])])])):S("",!0)}},ge=N(he,[["__scopeId","data-v-43408baf"]]),fe={key:0,id:"endGameModal",class:"modal"},ye={__name:"EndGameModal",props:{show:{type:Boolean,default:!1}},emits:["close","confirm"],setup(t,{emit:o}){const e=o;function s(){e("confirm")}function a(){e("close")}return(i,c)=>t.show?(l(),u("div",fe,[n("div",{class:"modal-content"},[c[0]||(c[0]=n("h2",null,"Xác nhận kết thúc",-1)),c[1]||(c[1]=n("p",{class:"modal-message"}," Bạn có chắc chắn muốn kết thúc ván bài này? Sau khi kết thúc sẽ không thể chỉnh sửa điểm. ",-1)),n("div",{class:"modal-buttons"},[n("button",{id:"confirmEndGame",class:"danger-btn",onClick:s},"Kết thúc"),n("button",{id:"cancelEndGame",class:"secondary-btn",onClick:a},"Hủy")])])])):S("",!0)}},be={key:0,class:"container",id:"content"},Se={key:1,class:"winner-message"},ve={class:"header"},pe={key:0,class:"room-badge"},ke={key:0,class:"table-header"},_e={__name:"ScoringView",setup(t){const o=L(),e=W(),s=H(),a=B(!1);function i(){a.value=e.isGameEnded&&!!e.winnerMessage}F(()=>{if(a.value=!1,!e.initGame()){alert("Không tìm thấy thông tin ván bài!"),o.push("/");return}i()}),R(()=>{var h;return[e.isGameEnded,e.winnerMessage,(h=e.game)==null?void 0:h.firebaseId]},()=>{i()},{immediate:!0}),U(()=>{e.cleanupSubscriptions(),a.value=!1});function c(){o.push("/")}function y(){e.setEditingRowIndex(null),s.showScoreModal()}function p(h){e.isGameEnded||(e.setEditingRowIndex(h),s.showScoreModal())}async function g(h){try{await e.saveScores(h)||alert("Có lỗi xảy ra khi lưu điểm. Hệ thống sẽ thử lưu cục bộ."),s.hideScoreModal()}catch(f){console.error("Lỗi khi lưu điểm:",f),alert("Có lỗi xảy ra khi lưu điểm. Hệ thống sẽ thử lưu cục bộ."),s.hideScoreModal()}}async function w(){try{await e.endGame()||alert("Có lỗi xảy ra khi kết thúc ván đấu. Vui lòng thử lại."),s.hideEndGameModal()}catch(h){console.error("Lỗi khi kết thúc game:",h),alert("Có lỗi xảy ra khi kết thúc ván đấu. Vui lòng thử lại.")}}return(h,f)=>r(e).game?(l(),u("div",be,[a.value?(l(),$(q,{key:0})):S("",!0),r(e).winnerMessage?(l(),u("div",Se,v(r(e).winnerMessage),1)):S("",!0),n("div",ve,[f[3]||(f[3]=n("h1",null,"Ghi Điểm Ván Bài",-1)),n("a",{onClick:c,class:"back-btn",id:"backButton"},"← Trở về"),r(e).currentRoom?(l(),u("div",pe," Phòng: "+v(r(e).currentRoom),1)):S("",!0)]),r(e).gameStatus?(l(),u("div",{key:2,id:"gameStatus",style:x({display:r(e).gameStatus?"block":"none"})},v(r(e).gameStatus),5)):S("",!0),n("div",{class:E(["score-section",{"game-ended":r(e).isGameEnded}])},[r(e).isGameEnded?S("",!0):(l(),u("div",ke,[n("button",{id:"endGameBtn",class:"danger-btn small-btn",onClick:f[0]||(f[0]=I=>r(s).showEndGameModal())}," Kết thúc ván ")])),K(Y,{game:r(e).game,totalScores:r(e).totalScores,winnerIndex:r(e).isGameEnded?r(e).winnerIndex:-1,onEditRow:p},null,8,["game","totalScores","winnerIndex"])],2),r(e).isGameEnded?S("",!0):(l(),u("button",{key:3,id:"addScoreBtn",class:"primary-btn",onClick:y}," Thêm điểm mới ")),r(s).scoreModalVisible?(l(),$(ge,{key:4,show:r(s).scoreModalVisible,players:r(e).game.players,editingScores:r(e).editingRowIndex!==null?r(e).game.scores[r(e).editingRowIndex]:null,onClose:f[1]||(f[1]=I=>r(s).hideScoreModal()),onSave:g},null,8,["show","players","editingScores"])):S("",!0),r(s).endGameModalVisible?(l(),$(ye,{key:5,show:r(s).endGameModalVisible,onClose:f[2]||(f[2]=I=>r(s).hideEndGameModal()),onConfirm:w},null,8,["show"])):S("",!0)])):S("",!0)}};export{_e as default};
